<script>
const sample = {
  "type":"Feature",
  "properties":{},
  "geometry":{
    "type":"Polygon",
    "coordinates":[[
      [7.0, 51.0],
      [7.02, 51.0],
      [7.02, 51.01],
      [7.0, 51.01],
      [7.0, 51.0]
    ]]
  }
};
document.getElementById("aoi").value = JSON.stringify(sample, null, 2);

function buildBody() {
  return {
    aoi: JSON.parse(document.getElementById("aoi").value),
    gsd_cm: Number(document.getElementById("gsd").value),
    overlap: {
      front: Number(document.getElementById("front").value),
      side: Number(document.getElementById("side").value)
    },
    speed_mps: Number(document.getElementById("speed").value),
    heading_deg: 0
  };
}

async function safeJson(response) {
  try { return await response.json(); }
  catch { return null; }
}

document.getElementById("plan").onclick = async () => {
  try {
    const body = buildBody();
    const r = await fetch("/api/droneplanner/plan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await safeJson(r);
    if (!r.ok) {
      alert((data && data.error) ? data.error : `Plan failed (${r.status})`);
      return;
    }

    document.getElementById("out").textContent = JSON.stringify(data, null, 2);
  } catch (e) {
    alert(`Plan error: ${e?.message || e}`);
  }
};

document.getElementById("downloadQgc").onclick = async () => {
  try {
    const body = buildBody();
    const r = await fetch("/api/droneplanner/export/qgc", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!r.ok) {
      const err = await safeJson(r);
      alert((err && err.error) ? err.error : `Export failed (${r.status})`);
      return;
    }

    const blob = await r.blob();
    const url = URL.createObjectURL(blob);

    // Try to use filename from header
    const cd = r.headers.get("content-disposition") || "";
    const match = cd.match(/filename="([^"]+)"/i);
    const filename = match?.[1] || "WK_Mission.plan";

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    alert(`Export error: ${e?.message || e}`);
  }
};
</script>


