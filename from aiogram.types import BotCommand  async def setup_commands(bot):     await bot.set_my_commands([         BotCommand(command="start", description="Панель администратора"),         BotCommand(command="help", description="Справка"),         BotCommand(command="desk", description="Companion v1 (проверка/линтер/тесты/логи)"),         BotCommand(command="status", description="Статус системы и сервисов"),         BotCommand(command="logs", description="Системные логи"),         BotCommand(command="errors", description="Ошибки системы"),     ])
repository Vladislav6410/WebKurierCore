#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
WebKurier Admin Bot (Telegram) ‚Äî —É–ø—Ä–∞–≤–ª—è—é—â–∞—è –∫–æ–Ω—Å–æ–ª—å –¥–ª—è WebKurierCore.

‚úÖ –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- –¢–æ–∫–µ–Ω –ù–ï —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ ENV: TELEGRAM_ADMIN_BOT_TOKEN)
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ allowlist (ENV: ADMIN_IDS="123,456")
- –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–∫–µ (–ø–æ —Ç–≤–æ–∏–º Scope –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –≤ Telegram)

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ:
AdminBot -> WebKurierCore API (CORE_ADMIN_API_URL) -> –∞–≥–µ–Ω—Ç—ã/–º–æ–¥—É–ª–∏
"""

import os
import logging
from typing import Any, Dict, Optional, List

import aiohttp
from aiogram import Bot, Dispatcher, Router, F
from aiogram.enums import ParseMode
from aiogram.filters import Command
from aiogram.types import Message, BotCommand, ReplyKeyboardMarkup, KeyboardButton

# ---------------------------
# ENV / CONFIG
# ---------------------------
BOT_TOKEN = os.getenv("TELEGRAM_ADMIN_BOT_TOKEN", "").strip()
CORE_ADMIN_API_URL = os.getenv("CORE_ADMIN_API_URL", "http://127.0.0.1:8080/admin").rstrip("/")
ADMIN_IDS_RAW = os.getenv("ADMIN_IDS", "").strip()  # example: "123456789,987654321"
REQUEST_TIMEOUT_SEC = float(os.getenv("CORE_API_TIMEOUT", "8"))

if not BOT_TOKEN:
    raise RuntimeError("Missing ENV TELEGRAM_ADMIN_BOT_TOKEN")


def _parse_admin_ids(raw: str) -> List[int]:
    ids: List[int] = []
    if not raw:
        return ids
    for part in raw.split(","):
        part = part.strip()
        if not part:
            continue
        try:
            ids.append(int(part))
        except ValueError:
            pass
    return ids


ADMIN_IDS = set(_parse_admin_ids(ADMIN_IDS_RAW))

# –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî —ç—Ç–æ –æ–ø–∞—Å–Ω–æ. –õ—É—á—à–µ —è–≤–Ω–æ –∑–∞–¥–∞—Ç—å.
if not ADMIN_IDS:
    logging.warning("ADMIN_IDS is empty. Set ENV ADMIN_IDS to restrict access (recommended).")

# ---------------------------
# Logging
# ---------------------------
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
)
log = logging.getLogger("webkurier-admin-bot")

# ---------------------------
# Helpers: auth + API calls
# ---------------------------
def is_admin(user_id: Optional[int]) -> bool:
    if user_id is None:
        return False
    # –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ: –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å–µ–º.
    return user_id in ADMIN_IDS


async def core_api_call(
    session: aiohttp.ClientSession,
    method: str,
    path: str,
    payload: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:
    """
    –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–∑–æ–≤ Core Admin API.
    –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
      { "ok": true, "data": {...} }
      { "ok": false, "error": "..." }
    """
    url = f"{CORE_ADMIN_API_URL}{path}"
    try:
        async with session.request(
            method=method,
            url=url,
            json=payload,
            timeout=aiohttp.ClientTimeout(total=REQUEST_TIMEOUT_SEC),
        ) as resp:
            text = await resp.text()
            if resp.headers.get("Content-Type", "").startswith("application/json"):
                data = await resp.json()
            else:
                data = {"ok": False, "error": f"Non-JSON response ({resp.status}): {text[:400]}"}

            if "ok" not in data:
                data = {"ok": resp.status < 400, "data": data, "status": resp.status}

            return data
    except aiohttp.ClientError as e:
        return {"ok": False, "error": f"Core API connection error: {e}"}
    except Exception as e:
        return {"ok": False, "error": f"Core API unexpected error: {e}"}


def fmt_kv(title: str, kv: Dict[str, Any]) -> str:
    lines = [f"*{title}*"]
    for k, v in kv.items():
        lines.append(f"‚Ä¢ `{k}`: `{v}`")
    return "\n".join(lines)


def ensure_admin(message: Message) -> bool:
    uid = message.from_user.id if message.from_user else None
    return is_admin(uid)


# ---------------------------
# Companion v1 Keyboard (–º–∞–≥–∏—è –∫–∞–∫ –≤ OpenClaw)
# ---------------------------
BTN_TREE = "‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞"
BTN_LINT = "üßπ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä"
BTN_TESTS = "üß™ –ü—Ä–æ–≥–Ω–∞—Ç—å —Ç–µ—Å—Ç—ã"
BTN_LOGS = "üìú –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏"
BTN_STATUS = "‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã"

COMPANION_BUTTONS = {BTN_TREE, BTN_LINT, BTN_TESTS, BTN_LOGS, BTN_STATUS}


def companion_keyboard() -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text=BTN_TREE)],
            [KeyboardButton(text=BTN_LINT)],
            [KeyboardButton(text=BTN_TESTS)],
            [KeyboardButton(text=BTN_LOGS)],
            [KeyboardButton(text=BTN_STATUS)],
        ],
        resize_keyboard=True,
        one_time_keyboard=False,
        input_field_placeholder="–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É‚Ä¶",
    )


# ---------------------------
# Bot / Router
# ---------------------------
router = Router()

ADMIN_START_TEXT = (
    "üõ† *WebKurier Admin Panel*\n\n"
    "‚ú® Companion v1 (–±—ã—Å—Ç—Ä—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏):\n"
    f"‚Ä¢ {BTN_TREE}\n"
    f"‚Ä¢ {BTN_LINT}\n"
    f"‚Ä¢ {BTN_TESTS}\n"
    f"‚Ä¢ {BTN_LOGS}\n\n"
    "–ö–æ–º–∞–Ω–¥—ã:\n"
    "‚Ä¢ /status ‚Äî —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –∏ —Å–µ—Ä–≤–∏—Å–æ–≤\n"
    "‚Ä¢ /health ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏\n"
    "‚Ä¢ /agents ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤\n"
    "‚Ä¢ /agent_on <agent> ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞\n"
    "‚Ä¢ /agent_off <agent> ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞\n"
    "‚Ä¢ /agent_restart <agent> ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞\n\n"
    "–ü–æ–¥—Å–∫–∞–∑–∫–∞:\n"
    "‚Äî –ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏.\n"
    "‚Äî –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö."
)

ADMIN_HELP_TEXT = (
    "üìò *–°–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ WebKurier*\n\n"
    "üß© –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:\n"
    "‚Ä¢ /status ‚Äî –∫—Ä–∞—Ç–∫–∏–π —Å—Ç–∞—Ç—É—Å Core/PhoneCore/Security/Chain/DroneHybrid\n"
    "‚Ä¢ /health ‚Äî ping/uptime/–æ—á–µ—Ä–µ–¥–∏/–æ—à–∏–±–∫–∏\n\n"
    "ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏:\n"
    "‚Ä¢ /agents ‚Äî —Å–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤ (ON/OFF, –≤–µ—Ä—Å–∏—è, –Ω–∞–≥—Ä—É–∑–∫–∞)\n"
    "‚Ä¢ /agent_on <agent> ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞\n"
    "‚Ä¢ /agent_off <agent> ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞\n"
    "‚Ä¢ /agent_restart <agent> ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞\n\n"
    "üß† –ü—Ä–∏–º–µ—Ä—ã:\n"
    "‚Ä¢ /agent_on translator\n"
    "‚Ä¢ /agent_restart voice\n\n"
    "üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:\n"
    "‚Äî –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ allowlist (ADMIN_IDS)\n"
    "‚Äî –≤ –≥—Ä—É–ø–ø–∞—Ö –∞–¥–º–∏–Ω-–±–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
)


@router.message(Command("start"))
async def cmd_start(message: Message):
    if not ensure_admin(message):
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return
    await message.answer(ADMIN_START_TEXT, parse_mode=ParseMode.MARKDOWN, reply_markup=companion_keyboard())


@router.message(Command("help"))
async def cmd_help(message: Message):
    if not ensure_admin(message):
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return
    await message.answer(ADMIN_HELP_TEXT, parse_mode=ParseMode.MARKDOWN)


@router.message(Command("status"))
async def cmd_status(message: Message):
    if not ensure_admin(message):
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return

    async with aiohttp.ClientSession() as session:
        res = await core_api_call(session, "GET", "/status")

    if not res.get("ok"):
        await message.answer(f"‚ùå /status error: {res.get('error', 'unknown')}")
        return

    data = res.get("data") or {}
    text = fmt_kv("‚úÖ Status", data) if isinstance(data, dict) else f"‚úÖ Status:\n{data}"
    await message.answer(text, parse_mode=ParseMode.MARKDOWN)


@router.message(Command("health"))
async def cmd_health(message: Message):
    if not ensure_admin(message):
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return

    async with aiohttp.ClientSession() as session:
        res = await core_api_call(session, "GET", "/health")

    if not res.get("ok"):
        await message.answer(f"‚ùå /health error: {res.get('error', 'unknown')}")
        return

    data = res.get("data") or {}
    text = fmt_kv("‚úÖ Health", data) if isinstance(data, dict) else f"‚úÖ Health:\n{data}"
    await message.answer(text, parse_mode=ParseMode.MARKDOWN)


@router.message(Command("agents"))
async def cmd_agents(message: Message):
    if not ensure_admin(message):
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return

    async with aiohttp.ClientSession() as session:
        res = await core_api_call(session, "GET", "/agents")

    if not res.get("ok"):
        await message.answer(f"‚ùå /agents error: {res.get('error', 'unknown')}")
        return

    data = res.get("data") or []
    if isinstance(data, list) and data:
        lines = ["ü§ñ *Agents*"]
        for a in data:
            if isinstance(a, dict):
                name = a.get("name", "?")
                state = a.get("state", "?")
                ver = a.get("version", "")
                load = a.get("load", "")
                tail = " ".join([x for x in [ver and f"v{ver}", load and f"load:{load}"] if x])
                lines.append(f"‚Ä¢ `{name}` ‚Äî *{state}*{(' ‚Äî ' + tail) if tail else ''}")
            else:
                lines.append(f"‚Ä¢ `{a}`")
        await message.answer("\n".join(lines), parse_mode=ParseMode.MARKDOWN)
    else:
        await message.answer("ü§ñ Agents: (empty)")


def _arg_after_command(message: Message) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    "/agent_on translator" -> "translator"
    """
    text = (message.text or "").strip()
    parts = text.split(maxsplit=1)
    return parts[1].strip() if len(parts) > 1 else ""


async def _agent_action(message: Message, action: str):
    if not ensure_admin(message):
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        return

    agent = _arg_after_command(message)
    if not agent:
        await message.answer(f"‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /agent_{action} <agent>\n–ü—Ä–∏–º–µ—Ä: /agent_{action} translator")
        return

    async with aiohttp.ClientSession() as session:
        res = await core_api_call(session, "POST", f"/agents/{action}", payload={"agent": agent})

    if not res.get("ok"):
        await message.answer(f"‚ùå /agent_{action} error: {res.get('error', 'unknown')}")
        return

    data = res.get("data") or {}
    msg = data.get("message") if isinstance(data, dict) else None
    await message.answer(f"‚úÖ agent_{action}: `{agent}`\n{msg or ''}".strip(), parse_mode=ParseMode.MARKDOWN)


@router.message(Command("agent_on"))
async def cmd_agent_on(message: Message):
    await _agent_action(message, "on")


@router.message(Command("agent_off"))
async def cmd_agent_off(message: Message):
    await _agent_action(message, "off")


@router.message(Command("agent_restart"))
async def cmd_agent_restart(message: Message):
    await _agent_action(message, "restart")


# ---------------------------
# Companion v1 Buttons -> Commands (–ø–æ–∫–∞ –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∞)
# –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Ç—É—Ç –¥–µ—Ä–≥–∞–µ–º WDA /jobs (Desktop Agent) —á–µ—Ä–µ–∑ Core
# ---------------------------
@router.message(F.text.in_(COMPANION_BUTTONS))
async def companion_buttons(message: Message):
    if not ensure_admin(message):
        return

    # –ú–∞–ø–ø–∏–Ω–≥ –∫–Ω–æ–ø–∫–∏ -> –±—É–¥—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞ Companion/WDA
    if message.text == BTN_TREE:
        await message.answer("‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω—è—é: /desk check core\n(—Å–∫–æ—Ä–æ –ø–æ–¥–∫–ª—é—á–∏–º WDA –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 64GB)")

    elif message.text == BTN_LINT:
        await message.answer("‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω—è—é: /desk lint core\n(—Å–∫–æ—Ä–æ –ø–æ–¥–∫–ª—é—á–∏–º WDA –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 64GB)")

    elif message.text == BTN_TESTS:
        await message.answer("‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω—è—é: /desk test core\n(—Å–∫–æ—Ä–æ –ø–æ–¥–∫–ª—é—á–∏–º WDA –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 64GB)")

    elif message.text == BTN_LOGS:
        await message.answer("‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω—è—é: /desk logs\n(—Å–∫–æ—Ä–æ –ø–æ–¥–∫–ª—é—á–∏–º WDA –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 64GB)")

    elif message.text == BTN_STATUS:
        # –≤—ã–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π /status handler, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —É–∂–µ —Ä–∞–±–æ—Ç–∞–ª–∞
        await cmd_status(message)


# ---------------------------
# Fallback
# ---------------------------
@router.message(F.text)
async def fallback_text(message: Message):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback: –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É.
    """
    if not ensure_admin(message):
        return
    await message.answer("‚ÑπÔ∏è –ù–µ –ø–æ–Ω—è–ª –∫–æ–º–∞–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–π /help –∏–ª–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É Companion v1.")


# ---------------------------
# Telegram menu commands (/menu)
# ---------------------------
async def setup_commands(bot: Bot):
    await bot.set_my_commands([
        BotCommand(command="start", description="–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"),
        BotCommand(command="help", description="–°–ø—Ä–∞–≤–∫–∞"),
        BotCommand(command="desk", description="Companion v1 (–ø—Ä–æ–≤–µ—Ä–∫–∞/–ª–∏–Ω—Ç–µ—Ä/—Ç–µ—Å—Ç—ã/–ª–æ–≥–∏)"),
        BotCommand(command="status", description="–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –∏ —Å–µ—Ä–≤–∏—Å–æ–≤"),
        BotCommand(command="health", description="Health-check"),
        BotCommand(command="agents", description="–°–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤"),
        BotCommand(command="agent_on", description="–í–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞: /agent_on <name>"),
        BotCommand(command="agent_off", description="–í—ã–∫–ª—é—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞: /agent_off <name>"),
        BotCommand(command="agent_restart", description="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–∞: /agent_restart <name>"),
        BotCommand(command="logs", description="–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (—Å–∫–æ—Ä–æ)"),
        BotCommand(command="errors", description="–û—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã (—Å–∫–æ—Ä–æ)"),
    ])


# ---------------------------
# Main
# ---------------------------
async def main():
    # –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º MARKDOWN, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–µ–∫—Å—Ç—ã —É —Ç–µ–±—è —Å * –∏ `...`
    bot = Bot(token=BOT_TOKEN, parse_mode=ParseMode.MARKDOWN)
    await setup_commands(bot)

    dp = Dispatcher()
    dp.include_router(router)

    log.info("Admin bot started. Core API: %s", CORE_ADMIN_API_URL)
    await dp.start_polling(bot)


if __name__ == "__main__":
    import asyncio
    asyncio.run(main())