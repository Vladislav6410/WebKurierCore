import CONFIG from "./engine/config.js";

// --- –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã ---
const commands = {
  "/help": {
    description: "–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥",
    exec: () => Object.entries(commands)
      .map(([cmd, obj]) => `${cmd} ‚Äî ${obj.description}`)
      .join("\n")
  },
  "/config": {
    description: "–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é",
    exec: () => "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥:\n" + JSON.stringify(CONFIG, null, 2)
  }
  // ...–¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–∏ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (–±–∞–ª–∞–Ω—Å, reset, clear –∏ —Ç.–¥.)...
};

// === MasterAgent ===
if (CONFIG.features?.master) {
  import("./engine/agents/master-agent.js").then((MasterAgent) => {
    commands["/agents"] = {
      description: "–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤",
      exec: async () => {
        const agents = await MasterAgent.listActiveAgents();
        return "ü§ñ –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:\n" + agents.map(a => `- ${a.name} (v${a.version})`).join("\n");
      }
    };
    commands["/tip"] = {
      description: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å WebCoin –∞–≥–µ–Ω—Ç—É: /tip [–∏–º—è] [—Å—É–º–º–∞]",
      exec: async ([agent, amount]) => {
        const result = await MasterAgent.sendCoins(agent, parseInt(amount, 10));
        return result.success
          ? `üì§ ${amount} WebCoin –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≥–µ–Ω—Ç—É ${agent}`
          : `‚ùå –û—à–∏–±–∫–∞: ${result.error}`;
      }
    };
    commands["/market"] = {
      description: "–ü–æ–∫–∞–∑–∞—Ç—å –∫—É—Ä—Å—ã WebCoin",
      exec: async () => {
        const rates = await MasterAgent.getExchangeRates();
        return "üìà –ö—É—Ä—Å—ã:\n" + Object.entries(rates).map(([cur, rate]) => `- 1 WC = ${rate} ${cur}`).join("\n");
      }
    };
    commands["/status"] = {
      description: "–°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞: /status [–∏–º—è]",
      exec: ([name]) => MasterAgent.status?.[name] || "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    };
    commands["/reload"] = {
      description: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–∞: /reload [–∏–º—è]",
      exec: ([name]) => {
        MasterAgent.reload(name);
        return `üîÅ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∞–≥–µ–Ω—Ç–∞ "${name}"...`;
      }
    };
  });
}

// === TranslatorAgent ===
if (CONFIG.features?.translator) {
  import("./engine/agents/translator/translator-agent.js").then((TranslatorAgent) => {
    commands["/translate"] = {
      description: "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç: /translate [—è–∑—ã–∫] [—Ç–µ–∫—Å—Ç]",
      exec: async ([lang, ...text]) => {
        const result = await TranslatorAgent.translate(text.join(" "), lang);
        return `üåê –ü–µ—Ä–µ–≤–æ–¥ (${lang}): ${result}`;
      }
    };
    commands["/lang"] = {
      description: "–ü–æ–∫–∞–∑–∞—Ç—å —è–∑—ã–∫–∏",
      exec: async () => {
        const langs = await TranslatorAgent.getLanguages();
        return "üåç –Ø–∑—ã–∫–∏: " + langs.join(", ");
      }
    };
    commands["/detect"] = {
      description: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫",
      exec: async ([...text]) => {
        const lang = await TranslatorAgent.detect(text.join(" "));
        return `üîé –Ø–∑—ã–∫: ${lang}`;
      }
    };
  });
}

// === DropboxAgent ===
if (CONFIG.features?.dropbox) {
  import("./engine/agents/dropbox/dropbox-agent.js").then((DropboxAgent) => {
    commands["/save"] = {
      description: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Dropbox",
      exec: async () => {
        // –ü—Ä–∏–º–µ—Ä: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–ª–∞–Ω—Å
        await DropboxAgent.uploadFile("wallet_backup.json", JSON.stringify({ balance: 100 }));
        return "üì¶ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Dropbox.";
      }
    };
    commands["/load"] = {
      description: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Dropbox",
      exec: async () => {
        const text = await DropboxAgent.downloadFile("wallet_backup.json");
        const json = JSON.parse(text);
        // setBalance(json.balance);
        return `üì• –ë–∞–ª–∞–Ω—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${json.balance} WebCoin.`;
      }
    };
    commands["/list"] = {
      description: "–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ Dropbox",
      exec: async () => {
        const files = await DropboxAgent.listFiles();
        return "üóÉ –§–∞–π–ª—ã: " + files.join(", ");
      }
    };
    commands["/backup"] = {
      description: "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –≤ Dropbox",
      exec: async () => {
        // ...–ª–æ–≥–∏–∫–∞ –±—ç–∫–∞–ø–∞...
        return "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞.";
      }
    };
  });
}

// === LegalAgent ===
if (CONFIG.features?.legal) {
  import("./engine/agents/legal/legal-agent.js").then((LegalAgent) => {
    commands["/legal"] = {
      description: "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å: analyze/template/help",
      exec: async ([action, ...args]) => {
        if (action === "analyze") return await LegalAgent.analyze(args.join(" "));
        if (action === "template") return await LegalAgent.template(args.join(" "));
        if (action === "help") return await LegalAgent.help();
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: analyze, template, help";
      }
    };
  });
}

// === ToolsAgent ===
if (CONFIG.features?.tools) {
  import("./engine/agents/tools/tools-agent.js").then((ToolsAgent) => {
    commands["/build"] = {
      description: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML",
      exec: async ([...args]) => await ToolsAgent.build(args.join(" "))
    };
    commands["/preview"] = {
      description: "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä HTML",
      exec: async ([...args]) => await ToolsAgent.preview(args.join(" "))
    };
    commands["/exportzip"] = {
      description: "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ZIP",
      exec: async () => await ToolsAgent.exportZip()
    };
  });
}

// === LayoutAgent ===
if (CONFIG.features?.layout) {
  import("./engine/agents/layout/layout-agent.js").then((LayoutAgent) => {
    commands["/layout"] = {
      description: "–í—ë—Ä—Å—Ç–∫–∞: build/fixcss",
      exec: async ([action, ...args]) => {
        if (action === "build") return await LayoutAgent.build(args.join(" "));
        if (action === "fixcss") return await LayoutAgent.fixCss(args.join(" "));
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: build, fixcss";
      }
    };
  });
}

// === BudgetAgent ===
if (CONFIG.features?.budget) {
  import("./engine/agents/budget/budget-agent.js").then((BudgetAgent) => {
    commands["/budget"] = {
      description: "–ë—é–¥–∂–µ—Ç: add/chart",
      exec: async ([action, ...args]) => {
        if (action === "add") return await BudgetAgent.add(args.join(" "));
        if (action === "chart") return await BudgetAgent.chart();
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: add, chart";
      }
    };
  });
}

// === ReportAgent ===
if (CONFIG.features?.report) {
  import("./engine/agents/report/report-agent.js").then((ReportAgent) => {
    commands["/report"] = {
      description: "–û—Ç—á—ë—Ç—ã: generate/last",
      exec: async ([action, ...args]) => {
        if (action === "generate") return await ReportAgent.generate(args.join(" "));
        if (action === "last") return await ReportAgent.last();
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: generate, last";
      }
    };
  });
}

// === ModuleAgent ===
if (CONFIG.features?.module) {
  import("./engine/agents/module/module-agent.js").then((ModuleAgent) => {
    commands["/module"] = {
      description: "–ú–æ–¥—É–ª–∏: list/enable",
      exec: async ([action, ...args]) => {
        if (action === "list") return await ModuleAgent.list();
        if (action === "enable") return await ModuleAgent.enable(args[0]);
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: list, enable";
      }
    };
  });
}

// === AIHelperAgent ===
if (CONFIG.features?.aihelper) {
  import("./engine/agents/aihelper/aihelper-agent.js").then((AIHelperAgent) => {
    commands["/ai"] = {
      description: "AI-–ø–æ–º–æ—â–Ω–∏–∫: suggest/help",
      exec: async ([action, ...args]) => {
        if (action === "suggest") return await AIHelperAgent.suggest(args.join(" "));
        if (action === "help") return await AIHelperAgent.help();
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: suggest, help";
      }
    };
  });
}

// === NavigatorAgent ===
if (CONFIG.features?.navigator) {
  import("./engine/agents/navigator/navigator-agent.js").then((NavigatorAgent) => {
    commands["/nav"] = {
      description: "–ù–∞–≤–∏–≥–∞—Ü–∏—è: start/location",
      exec: async ([action, ...args]) => {
        if (action === "start") return await NavigatorAgent.start(args.join(" "));
        if (action === "location") return await NavigatorAgent.location();
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: start, location";
      }
    };
  });
}

// === MarketingAgent ===
if (CONFIG.features?.marketing) {
  import("./engine/agents/marketing/marketing-agent.js").then((MarketingAgent) => {
    commands["/ads"] = {
      description: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: idea/slogan",
      exec: async ([action, ...args]) => {
        if (action === "idea") return await MarketingAgent.idea(args.join(" "));
        if (action === "slogan") return await MarketingAgent.slogan(args.join(" "));
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: idea, slogan";
      }
    };
  });
}

// === WalletAgent ===
if (CONFIG.features?.wallet) {
  import("./engine/agents/wallet/wallet-agent.js").then((WalletAgent) => {
    commands["/wallet"] = {
      description: "–ö–æ—à–µ–ª—ë–∫: send/export",
      exec: async ([action, ...args]) => {
        if (action === "send") return await WalletAgent.send(args[0], args[1]);
        if (action === "export") return await WalletAgent.export();
        return "–î–æ—Å—Ç—É–ø–Ω—ã–µ: send, export";
      }
    };
  });
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ ---
async function handleCommand(event) {
  if (event.key === "Enter" || event.type === "run") {
    const input = document.getElementById("terminal-input");
    const cmd = input.value.trim();
    input.value = "";
    if (!cmd) return;

    printToTerminal("> " + cmd);

    const [command, ...args] = cmd.split(" ");
    const action = commands[command];

    if (!action) {
      printToTerminal("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help", true);
      return;
    }

    try {
      const result = await action.exec(args);
      if (result) printToTerminal(result);
    } catch (err) {
      printToTerminal("‚ö†Ô∏è " + err, true);
    }
  }
}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("terminal-input");
  if (input) input.addEventListener("keydown", handleCommand);
});

// --- –í—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª ---
function printToTerminal(message, isError = false) {
  const output = document.getElementById("terminal-output") || document.getElementById("terminal-log");
  if (!output) return;
  const line = document.createElement("div");
  line.textContent = message;
  line.style.color = isError ? "red" : "white";
  output.appendChild(line);
  output.scrollTop = output.scrollHeight;
}
