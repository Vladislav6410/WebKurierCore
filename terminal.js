import * as MasterAgent from "./engine/agents/master-agent.js";

const WALLET_KEY = "webcoin_balance";

// –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
function getBalance() {
  return parseInt(localStorage.getItem(WALLET_KEY) || "0", 10);
}

function setBalance(amount) {
  localStorage.setItem(WALLET_KEY, amount);
  localStorage.setItem("wallet_updated", new Date().toISOString());
  if (!localStorage.getItem("wallet_created")) {
    localStorage.setItem("wallet_created", new Date().toISOString());
  }
  updateBalanceUI();
}

function addCoins(amount) {
  const current = getBalance();
  setBalance(current + amount);
}

function resetWallet() {
  setBalance(0);
}

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
function updateBalanceUI() {
  const el = document.getElementById("wallet-balance");
  if (el) {
    el.textContent = "üí∞ –ë–∞–ª–∞–Ω—Å: " + getBalance() + " WebCoin";
  }
}

function printToTerminal(message, isError = false) {
  const output = document.getElementById("terminal-output");
  if (!output) return;

  const line = document.createElement("div");
  line.textContent = message;
  line.style.color = isError ? "red" : "white";
  output.appendChild(line);
  output.scrollTop = output.scrollHeight;
}

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
const walletCommands = {
  "/add": {
    description: "/add [—á–∏—Å–ª–æ] ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã",
    exec: (args) => {
      const amount = parseInt(args[0] || "10", 10);
      if (isNaN(amount) || amount <= 0) throw "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.";
      addCoins(amount);
      return `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${amount} WebCoin.`;
    }
  },
  "/reset": {
    description: "/reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å",
    exec: () => {
      resetWallet();
      return "üîÅ –ë–∞–ª–∞–Ω—Å —Å–±—Ä–æ—à–µ–Ω.";
    }
  },
  "/balance": {
    description: "/balance ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å",
    exec: () => `üí∞ –ë–∞–ª–∞–Ω—Å: ${getBalance()} WebCoin.`
  },
  "/set": {
    description: "/set [—á–∏—Å–ª–æ] ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å",
    exec: (args) => {
      const amount = parseInt(args[0], 10);
      if (isNaN(amount) || amount < 0) throw "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ.";
      setBalance(amount);
      return `üîß –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –±–∞–ª–∞–Ω—Å: ${amount} WebCoin.`;
    }
  },
  "/help": {
    description: "/help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥",
    exec: () => Object.values(walletCommands).map(c => "üìå " + c.description).join("\n")
  },
  "/stats": {
    description: "/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—à–µ–ª—å–∫–∞",
    exec: () => {
      const created = new Date(localStorage.getItem("wallet_created") || Date.now()).toLocaleString();
      const updated = new Date(localStorage.getItem("wallet_updated") || Date.now()).toLocaleString();
      return `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\nü™ô –ë–∞–ª–∞–Ω—Å: ${getBalance()} WebCoin\nüìÖ –°–æ–∑–¥–∞–Ω: ${created}\nüïì –û–±–Ω–æ–≤–ª—ë–Ω: ${updated}`;
    }
  },
  "/export": {
    description: "/export ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ —Ñ–∞–π–ª",
    exec: () => {
      const data = JSON.stringify({ 
        balance: getBalance(),
        created: localStorage.getItem("wallet_created"),
        updated: localStorage.getItem("wallet_updated")
      });
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "webcoin_wallet.json";
      a.click();
      return "üíæ –ë–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª.";
    }
  },
  "/import": {
    description: "/import ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∫–æ—à–µ–ª—å–∫–∞",
    exec: () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (typeof data.balance === "number") {
              setBalance(data.balance);
              if (data.created) localStorage.setItem("wallet_created", data.created);
              if (data.updated) localStorage.setItem("wallet_updated", data.updated);
              printToTerminal("üì• –ë–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∂–µ–Ω: " + data.balance + " WebCoin.");
            } else {
              throw "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.";
            }
          } catch (e) {
            printToTerminal("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + e, true);
          }
        };
        reader.readAsText(file);
      };
      input.click();
      return "üìÇ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∫–æ—à–µ–ª—å–∫–∞.";
    }
  },
  "/tip": {
    description: "/tip [–∞–≥–µ–Ω—Ç] [—Å—É–º–º–∞] ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–≥–µ–Ω—Ç—É WebCoin",
    exec: async ([agent, amount]) => {
      const value = parseInt(amount, 10);
      if (!agent || isNaN(value) || value <= 0) throw "–£–∫–∞–∂–∏ –∞–≥–µ–Ω—Ç–∞ –∏ —Å—É–º–º—É.";
      if (getBalance() < value) throw "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.";
      
      // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MasterAgent
      const result = await MasterAgent.sendCoins(agent, value);
      if (!result.success) throw `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`;
      
      setBalance(getBalance() - value);
      return `üì§ ${value} WebCoin –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≥–µ–Ω—Ç—É ${agent}`;
    }
  },
  "/history": {
    description: "/history ‚Äî –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π",
    exec: () => {
      const history = JSON.parse(localStorage.getItem("wallet_history") || "[]");
      if (history.length === 0) return "üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞";
      
      return history.map((entry, i) => 
        `${i+1}. ${entry.date}: ${entry.type} ${entry.amount} WC ‚Üí ${entry.balance} WC`
      ).join("\n");
    }
  },
  "/sync": {
    description: "/sync ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º",
    exec: async () => {
      try {
        const res = await fetch("/api/sync-balance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            balance: getBalance(),
            created: localStorage.getItem("wallet_created"),
            updated: localStorage.getItem("wallet_updated")
          })
        });
        const json = await res.json();
        return "üåê –ë–∞–ª–∞–Ω—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω: " + (json.status || "—É—Å–ø–µ—à–Ω–æ");
      } catch (e) {
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: " + e;
      }
    }
  },
  "/agents": {
    description: "/agents ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤",
    exec: async () => {
      try {
        const agents = await MasterAgent.listActiveAgents();
        return "ü§ñ –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã:\n" + agents.map(a => `- ${a.name} (v${a.version})`).join("\n");
      } catch (e) {
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤: " + e;
      }
    }
  },
  "/market": {
    description: "/market ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ä—ã–Ω–æ—á–Ω—ã–µ –∫—É—Ä—Å—ã",
    exec: async () => {
      try {
        const rates = await MasterAgent.getExchangeRates();
        return `üìà –†—ã–Ω–æ—á–Ω—ã–µ –∫—É—Ä—Å—ã:\n${Object.entries(rates)
          .map(([currency, rate]) => `- 1 WebCoin = ${rate} ${currency}`)
          .join("\n")}`;
      } catch (e) {
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤: " + e;
      }
    }
  }
};

// –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
function logTransaction(type, amount) {
  const history = JSON.parse(localStorage.getItem("wallet_history") || "[]");
  history.push({
    date: new Date().toLocaleString(),
    type,
    amount,
    balance: getBalance()
  });
  localStorage.setItem("wallet_history", JSON.stringify(history.slice(-50)));
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è
const originalAddCoins = addCoins;
addCoins = (amount) => {
  originalAddCoins(amount);
  logTransaction("DEPOSIT", amount);
};

const originalSetBalance = setBalance;
setBalance = (amount) => {
  const diff = amount - getBalance();
  originalSetBalance(amount);
  if (diff !== 0) {
    logTransaction(diff > 0 ? "DEPOSIT" : "WITHDRAW", Math.abs(diff));
  }
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã
async function handleWalletCommand(command) {
  const [cmd, ...args] = command.trim().split(/\s+/);
  const commandEntry = walletCommands[cmd];
  if (!commandEntry) return "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help.";
  try {
    return await commandEntry.exec(args);
  } catch (err) {
    return `‚ö†Ô∏è ${err}`;
  }
}

// –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–∞–Ω–¥
let commandHistory = [];
let historyIndex = -1;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener("DOMContentLoaded", () => {
  // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
  if (!localStorage.getItem("wallet_created")) {
    localStorage.setItem("wallet_created", new Date().toISOString());
  }
  
  updateBalanceUI();

  const addBtn = document.getElementById("add-coins");
  const resetBtn = document.getElementById("reset-wallet");
  const executeBtn = document.getElementById("execute-command");
  const input = document.getElementById("terminal-input");
  const output = document.getElementById("terminal-output");

  async function runCommand() {
    const cmd = input.value.trim();
    if (!cmd) return;

    printToTerminal("> " + cmd);
    commandHistory.unshift(cmd);
    commandHistory = commandHistory.slice(0, 10);
    historyIndex = -1;

    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DreamMaker
    let response;
    if (window.lastMedia) {
      const img = window.lastMedia.image;
      const vid = window.lastMedia.video;
      const aud = window.lastMedia.audio;

      if (vid) response = dreammaker.fromVideo(vid);
      else if (img && aud) response = dreammaker.animate(img, aud);
      else if (aud && !img) response = '–£–∫–∞–∂–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–µ —Å–æ –∑–≤—É–∫–æ–º.';
      else response = await handleWalletCommand(cmd);

      window.lastMedia = {};
    } else {
      response = await handleWalletCommand(cmd);
      if (!response && cmd) response = dreammaker.voiceOver(cmd);
    }

    printToTerminal(response, response.startsWith("‚ö†Ô∏è") || response.startsWith("‚ùå"));
    updateBalanceUI();
    input.value = "";
  }

  if (addBtn) addBtn.onclick = () => {
    addCoins(10);
    updateBalanceUI();
  };

  if (resetBtn) resetBtn.onclick = () => {
    resetWallet();
    updateBalanceUI();
  };

  if (executeBtn) executeBtn.onclick = runCommand;

  if (input) {
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") runCommand();
      else if (e.key === "ArrowUp") {
        if (commandHistory.length > 0) {
          historyIndex = Math.min(historyIndex + 1, commandHistory.length - 1);
          input.value = commandHistory[historyIndex];
        }
        e.preventDefault();
      } else if (e.key === "ArrowDown") {
        if (historyIndex > 0) {
          historyIndex--;
          input.value = commandHistory[historyIndex];
        } else {
          historyIndex = -1;
          input.value = "";
        }
        e.preventDefault();
      }
    });
  }
});
